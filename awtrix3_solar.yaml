---
blueprint:
  name: AWTRIX Solar Energy Monitor (AWTRIX 3) – dual sensors alternating
  description: >
    Wyświetla na AWTRIX 3 naprzemiennie dwie wartości:
    - Power Sensor (W/kW z progami i kolorami),
    - Power Sensor2 (kW, 2 miejsca po przecinku).
    Ikony: 54156 (zielony), 50557 (biały dyn), 50546 (statyczny).

  domain: automation
  input:
    awtrix:
      name: AWTRIX Device
      description: Select your AWTRIX 3 device (MQTT)
      selector:
        device:
          integration: mqtt
          manufacturer: Blueforcer
          model: AWTRIX 3
          multiple: true

    power_source:
      name: Power Sensor
      description: Sensor providing current power from your solar system.
      selector:
        entity:
          domain: [sensor]
          multiple: false

    sensor_unit:
      name: Sensor unit
      description: W jakich jednostkach podaje wartość Twój sensor?
      selector:
        select:
          options: [W, kW]
      default: W

    secondary_power_source:
      name: Power Sensor2
      description: Drugi sensor (kW, dwie cyfry po przecinku).
      selector:
        entity:
          domain: [sensor]
          multiple: false

    threshold_high:
      name: Threshold for high solar production (W)
      selector:
        number: {min: 0, max: 100000, unit_of_measurement: Watt, mode: slider}
      default: 400

    threshold_low:
      name: Threshold for low solar production (W)
      selector:
        number: {min: 0, max: 100000, unit_of_measurement: Watt, mode: slider}
      default: 100

    skip_if_zero_watts:
      name: Hide solar production if at 0 Watts
      selector: {boolean:}
      default: false

    skip_during_night_hours:
      name: Hide solar production during night time
      selector: {boolean:}
      default: false

    night_starts_after_time:
      name: Night Time Start
      default: "00:00:00"
      selector: {time: {}}

    night_ends_after_time:
      name: Night Time End
      default: "00:00:00"
      selector: {time: {}}

    refresh_minutes:
      name: Refresh pattern (minutes)
      description: |
        Wzór dla pola `minutes:` w time_pattern.
        Przykłady:
        - "/1"  → co minutę
        - "/5"  → co 5 minut
        - "0,15,30,45" → co kwadrans
      selector:
        text:
          multiline: false
      default: "/1"

    screen_duration_s:
      name: Screen duration (seconds)
      description: Ile sekund ma być widoczny każdy ekran w ramach jednej appki.
      selector:
        number: {min: 1, max: 30, unit_of_measurement: s, mode: slider}
      default: 5

mode: single

variables:
  device_ids: !input awtrix

  devices_topics: >-
    {%- macro get_device_topic(device_id) -%}
    {{ states((device_entities(device_id) | select('search','device_topic') | list)[0]) }}
    {%- endmacro -%}
    {%- set ns = namespace(devices=[]) -%}
    {%- for device_id in device_ids -%}
      {%- set device=get_device_topic(device_id)|replace(' ','') -%}
      {%- set ns.devices = ns.devices + [ device ~ '/custom/solar_power'] -%}
    {%- endfor -%}
    {{ ns.devices }}

  # Sensor #1
  power_sensor: !input power_source
  sensor_unit: !input sensor_unit
  raw_power: "{{ states[power_sensor].state | float(0) | abs }}"

  power_level: >-
    {% if sensor_unit == 'kW' %}
      {{ (raw_power * 1000) | round(0) }}
    {% else %}
      {{ raw_power | round(0) }}
    {% endif %}

  threshold_low: !input threshold_low
  threshold_high: !input threshold_high

  power_level_icon: >-
    {%- if power_level | float > threshold_high | float -%}54156
    {%- elif power_level | float > threshold_low | float -%}50557
    {%- else -%}50546
    {%- endif -%}

  power_level_color: >-
    {%- if power_level | float > threshold_high | float -%}#04FE04
    {%- elif power_level | float > threshold_low | float -%}#FCFEFC
    {%- else -%}#FF4E1A
    {%- endif -%}

  power_level_text: >-
    {%- if (power_level | float) > 1000 -%}
      {{ ((power_level | float) / 1000) | round(1) }} kW
    {%- else -%}
      {{ (power_level | float) | round(0) }} W
    {%- endif -%}

  # Sensor #2
  secondary_power_sensor: !input secondary_power_source
  secondary_raw_kw: "{{ states[secondary_power_sensor].state | float(0) | abs }}"
  secondary_kw_text: "{{ '%.2f' | format(secondary_raw_kw) }} kW"

  skip_if_zero_watts: !input skip_if_zero_watts
  skip_during_night_hours: !input skip_during_night_hours
  screen_duration_s: !input screen_duration_s

  payload: >-
    {
      "screens": [
        {"icon": {{ power_level_icon }}, "text": "{{ power_level_text }}", "color": "{{ power_level_color }}", "duration": {{ screen_duration_s }}},
        {"icon": {{ power_level_icon }}, "text": "{{ secondary_kw_text }}", "color": "{{ power_level_color }}", "duration": {{ screen_duration_s }}}
      ]
    }

  night_start: !input night_starts_after_time
  night_end: !input night_ends_after_time

trigger:
  - platform: time_pattern
    minutes: !input refresh_minutes

condition: []

action:
  - choose:
      - alias: "Skipping"
        conditions:
          - condition: template
            value_template: >
              {% set now_time = now().strftime("%H:%M") %}
              {{ (skip_during_night_hours and ((now_time < night_end) or (now_time > night_start))) or
                 (skip_if_zero_watts and (power_level | float == 0)) }}
        sequence:
          - repeat:
              for_each: "{{ devices_topics }}"
              sequence:
                - service: mqtt.publish
                  data:
                    qos: 0
                    retain: false
                    topic: "{{ repeat.item }}"
                    payload: '{}'

      - alias: "Not skipping"
        conditions:
          - condition: template
            value_template: >
              {% set now_time = now().strftime("%H:%M") %}
              {{ not ((skip_during_night_hours and ((now_time < night_end) or (now_time > night_start))) or
                      (skip_if_zero_watts and (power_level | float == 0))) }}
        sequence:
          - repeat:
              for_each: "{{ devices_topics }}"
              sequence:
                - service: mqtt.publish
                  data:
                    qos: 0
                    retain: false
                    topic: "{{ repeat.item }}"
                    payload: "{{ payload }}"
